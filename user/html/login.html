<%
var conf = arguments[0] || {};
var login = User.findMyLocation();
%>
<script src="/~~/ui/js/md5.js"></script>
<script>

  var url = "<%= login %>/doLogin?to=<%= escape( conf.to || request.getURL() ) %>";
  var prefix = "<%= md5( SERVER_HOSTNAME + (new Date()).roundMinutes( 7 ) ) %>";
  var area = "<%= db.getName() %>";

  function processLoginForm( frm ){

    if ( ! frm ) frm = document.getElementById( "login_form" );

    var u = url;
    if ( u.indexOf( "?" ) < 0 ) u += "?";
    u += "&prefix=" + prefix;
    u += "&username=" + frm.login_user.value;
    u += "&hash=" + hex_md5( prefix + ":" + hex_md5( frm.login_user.value + ":" + area + ":" + frm.login_pass  ) );

    if ( frm.login_remember.value == "yes" ) u += "&remember=t";


    location.href = u;
    return false;
  }
</script>

<div ? user >
  <div class="notice">You are already logged in as <strong><%= user.name %> (<%= user.email %>)</strong>.<br/><br/>If you would like to log in as another user, please <a href="<%= login %>/logout?to=<%= escape( request.getURL() ) %>">log out</a> first.</div>
</div>

<div ? ( ! user ) id="login">

    <form id="login_form" method="POST" action="/goaway" onSubmit="return processLoginForm( this )" class="edit login">
        <fieldset class="login">
            <legend>Login</legend>

            <table>
                <tr>
                    <td><label for="login_user">Username</label></td>
                    <td><input name="login_user" class="text"></td>
                </tr>
                <tr>
                    <td><label for="login_password">Password</label></td>
                    <td><input type="password" name="login_pass" class="text"></td>
                </tr>
                <tr>
                    <td></td>
                    <td><input type="checkbox" name="login_remember" value="yes" > Remember me</td>
                </tr>
                <tr>
                    <td></td>
                    <td>
                        <input type="submit" name="action" value="Login" class="button">
                        <strong ? ( "11" == request.getCookie( "__sudo" ) ) style="color:red;">sudo</strong>
                    </td>
                </tr>
            </table>
    </fieldset>
  </form>

</div>
