<%
core.app.bugtracker.data.area();

var proj = db.bugtracker.projects.findOne( { name : request.edproject } );

if(request.action == "add") {
    for(var i=0; i<proj.areas.length; i++) {
        if(proj.areas[i].name == request.newarea)  {
            print("");
            return;
        }
    }

    proj.areas.push(new app.bugtracker.data.Area(request.newarea, request.edproject));
    db.bugtracker.projects.save(proj);
    print(request.newarea);
    return;
}
else if(request.action == "rename") {
    if(request.newarea == "")
        return;

    for(var i=0; i<proj.areas.length; i++) {
        if(proj.areas[i].name == request.oldarea)  {
            proj.areas[i].name=request.newarea;
            db.bugtracker.projects.save(proj);
            break;
        }
    }
    bugs = db.bugtracker.cases.find({area: request.oldarea}).toArray();
    for(var b in bugs) {
        bugs[b].area = request.newarea;
        db.bugtracker.cases.save(bugs[b]);
    }
}
else if(request.action == "delete") {
    proj.areas = proj.areas.filter(function(a) {
        if(a.name == request.delarea)  {
            return false;
        }
        return true;
    });
    db.bugtracker.projects.save(proj);
    bugs = db.bugtracker.cases.find({area: request.delarea}).toArray();
    for(var b in bugs) {
        bugs[b].area = null;
        db.bugtracker.cases.save(bugs[b]);
    }
}
else if(request.action == "owner") {
    var owner;
    if(request.edowner == "null")
        owner = null;
    else
        owner = db.users.findOne({ _id : request.edowner });

    proj.owner = owner;
    db.bugtracker.projects.save(proj);
}
%>
